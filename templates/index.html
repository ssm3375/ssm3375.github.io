<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hardware Security Insights</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f0f0f0; }
    header { background: #500000;  color: white; padding: 20px; text-align: center; }
  </style>
  <script>
    $(function () {
      $("#hardware").load("includes/hardware_cves.html");
      $("#about").load("includes/about.html");
    });
  </script>
</head>
<body>

  <header>
    <h1>Hardware Security Insights</h1>
    <p>Modular dashboard for CVEs, vendors, charts, and more</p>
  </header>

  <div id="about"></div>
  <div id="hardware"></div>
  <div id="charts"></div>

  
  <!-- ðŸ§  Move your chart/filter script here -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_BASE = "https://ssm3375-github-io.onrender.com";
    let allCVEs = [];

    function fetchAllCVEs() {
      fetch(`${API_BASE}/files`)
        .then(res => res.json())
        .then(files => {
          return Promise.all(files.map(f => fetch(`${API_BASE}/file/${f}`).then(r => r.json())));
        })
        .then(data => {
          allCVEs = data;
          populateDropdowns();
          renderChart();
          renderList(data);
        });
    }

    function populateDropdowns() {
      const vendors = new Set();
      const products = new Set();
      const domains = new Set();

      allCVEs.forEach(cve => {
        if (cve.vendor) vendors.add(cve.vendor);
        if (cve.product) products.add(cve.product);
        (cve.references || []).forEach(url => {
          try {
            const domain = new URL(url).hostname;
            domains.add(domain);
          } catch {}
        });
      });

      populateSelect("vendor", vendors);
      populateSelect("product", products);
      populateSelect("reference", domains);
    }

    function populateSelect(id, values) {
      const el = document.getElementById(id);
      el.innerHTML = `<option value="">All</option>`;
      [...values].sort().forEach(v => el.innerHTML += `<option value="${v}">${v}</option>`);
    }

    function applyFilters() {
      const vendor = document.getElementById("vendor").value.toLowerCase();
      const product = document.getElementById("product").value.toLowerCase();
      const ref = document.getElementById("reference").value.toLowerCase();

      const filtered = allCVEs.filter(cve =>
        (!vendor || (cve.vendor || "").toLowerCase() === vendor) &&
        (!product || (cve.product || "").toLowerCase() === product) &&
        (!ref || (cve.references || []).some(url => {
          try {
            return new URL(url).hostname.toLowerCase() === ref;
          } catch { return false; }
        }))
      );

      renderList(filtered);
      renderChart(filtered);
    }

    function renderList(data) {
      const list = document.getElementById("filtered-cve-list");
      list.innerHTML = data.length === 0 ? "<li>No results found.</li>" : "";
      data.forEach(cve => {
        const item = document.createElement("li");
        item.innerHTML = `<strong>${cve.cve_id}</strong>: ${cve.description} <br><em>${cve.vendor || 'n/a'} - ${cve.product || 'n/a'}</em>`;
        list.appendChild(item);
      });
    }

    function renderChart(data = allCVEs) {
      const ctx = document.getElementById("cveChart").getContext("2d");
      const vendorCount = {};
      data.forEach(cve => {
        const v = cve.vendor || "Unknown";
        vendorCount[v] = (vendorCount[v] || 0) + 1;
      });

      if (window.cveChart) window.cveChart.destroy();
      window.cveChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(vendorCount),
          datasets: [{
            label: "# of CVEs",
            data: Object.values(vendorCount),
            backgroundColor: "rgba(128, 0, 0, 0.7)"
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: "Vendor" } },
            y: { title: { display: true, text: "# of CVEs" }, beginAtZero: true }
          }
        }
      });
    }

    fetchAllCVEs();
  </script>
</body>
</html>


