<div id="cve-filter" style="padding: 1em; background-color: #f8f8f8; border-radius: 10px;">
  <h2>üîç Filter Hardware CVEs</h2>
  <label for="vendor">Vendor:</label>
  <select id="vendor"><option value="">All</option></select>

  <label for="product">Product:</label>
  <select id="product"><option value="">All</option></select>

  <label for="reference">Reference Domain:</label>
  <select id="reference"><option value="">All</option></select>

  <button onclick="applyFilters()">Apply Filters</button>
</div>

<hr>

<div id="cve-chart-container">
  <h3>üìä CVEs by Vendor</h3>
  <canvas id="cveChart" style="max-height: 500px;"></canvas>
</div>

<hr>

<div id="filtered-cves">
  <h3>üßæ Filtered CVEs</h3>
  <ul id="filtered-cve-list">Loading...</ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const API_BASE = "";
  let allCVEs = [];

  function fetchAllCVEs() {
    fetch(`/api/files`)
      .then(res => res.json())
      .then(files => {
        Promise.all(files.map(f => fetch(`/api/file/${f}`).then(r => r.json())))
          .then(data => {
            allCVEs = data;
            populateDropdowns();
            renderChart();
            renderList(data);
          });
      });
  }

  function populateDropdowns() {
    const vendors = new Set();
    const products = new Set();
    const domains = new Set();

    allCVEs.forEach(cve => {
      if (cve.vendor) vendors.add(cve.vendor);
      if (cve.product) products.add(cve.product);
      if (cve.references) {
        cve.references.forEach(url => {
          try {
            const domain = new URL(url).hostname;
            domains.add(domain);
          } catch {}
        });
      }
    });

    const vendorSelect = document.getElementById("vendor");
    const productSelect = document.getElementById("product");
    const referenceSelect = document.getElementById("reference");

    vendors.forEach(v => vendorSelect.innerHTML += `<option value="${v}">${v}</option>`);
    products.forEach(p => productSelect.innerHTML += `<option value="${p}">${p}</option>`);
    domains.forEach(d => referenceSelect.innerHTML += `<option value="${d}">${d}</option>`);
  }

  function applyFilters() {
    const vendor = document.getElementById("vendor").value.toLowerCase();
    const product = document.getElementById("product").value.toLowerCase();
    const ref = document.getElementById("reference").value.toLowerCase();

    const filtered = allCVEs.filter(cve =>
      (!vendor || (cve.vendor && cve.vendor.toLowerCase() === vendor)) &&
      (!product || (cve.product && cve.product.toLowerCase() === product)) &&
      (!ref || cve.references.some(url => new URL(url).hostname.toLowerCase() === ref))
    );

    renderList(filtered);
    renderChart(filtered);
  }

  function renderList(data) {
    const list = document.getElementById("filtered-cve-list");
    list.innerHTML = "";
    if (data.length === 0) {
      list.innerHTML = "<li>No results found.</li>";
      return;
    }
    data.forEach(cve => {
      const item = document.createElement("li");
      item.innerHTML = `<strong>${cve.cve_id}</strong>: ${cve.description} <br><em>${cve.vendor || 'n/a'} - ${cve.product || 'n/a'}</em>`;
      list.appendChild(item);
    });
  }

  function renderChart(data = allCVEs) {
    const ctx = document.getElementById("cveChart").getContext("2d");
    const vendorCount = {};

    data.forEach(cve => {
      const v = cve.vendor || "Unknown";
      vendorCount[v] = (vendorCount[v] || 0) + 1;
    });

    const chartData = {
      labels: Object.keys(vendorCount),
      datasets: [{
        label: "# of CVEs",
        data: Object.values(vendorCount),
        backgroundColor: "rgba(128, 0, 0, 0.7)",
      }]
    };

    if (window.cveChart) window.cveChart.destroy();
    window.cveChart = new Chart(ctx, {
      type: "bar",
      data: chartData,
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { title: { display: true, text: "Vendor" } },
          y: { title: { display: true, text: "# of CVEs" }, beginAtZero: true }
        }
      }
    });
  }

  fetchAllCVEs();
</script>