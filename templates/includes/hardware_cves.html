<div id="cve-filter">
  <h2>Filter Hardware CVEs</h2>
  <label for="vendor">Vendor:</label>
  <input type="text" id="vendor" placeholder="e.g., Intel">

  <label for="product">Product:</label>
  <input type="text" id="product" placeholder="e.g., Xeon">

  <label for="reference">Reference Domain:</label>
  <input type="text" id="reference" placeholder="e.g., intel.com">

  <button onclick="applyFilters()">Apply Filters</button>
</div>

<hr>

<div id="cve-chart-container">
  <h3>CVEs by Vendor</h3>
  <canvas id="cveChart"></canvas>
</div>

<hr>

<div id="filtered-cves">
  <h3>Filtered CVEs</h3>
  <ul id="filtered-cve-list">Loading...</ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const API_BASE = "https://ssm3375-github-io.onrender.com";
  let allCVEs = [];

  function fetchAllCVEs() {
    fetch(`${API_BASE}/files`)
      .then(res => res.json())
      .then(files => {
        Promise.all(files.map(f => fetch(`${API_BASE}/file/${f}`).then(r => r.json())))
          .then(data => {
            allCVEs = data;
            renderChart();
            renderList(data);
          });
      });
  }

  function applyFilters() {
    const vendor = document.getElementById("vendor").value.toLowerCase();
    const product = document.getElementById("product").value.toLowerCase();
    const ref = document.getElementById("reference").value.toLowerCase();

    const filtered = allCVEs.filter(cve =>
      (!vendor || cve.vendor?.toLowerCase().includes(vendor)) &&
      (!product || cve.product?.toLowerCase().includes(product)) &&
      (!ref || cve.references.some(url => new URL(url).hostname.includes(ref)))
    );

    renderList(filtered);
    renderChart(filtered);
  }

  function renderList(data) {
    const list = document.getElementById("filtered-cve-list");
    list.innerHTML = "";
    data.forEach(cve => {
      const item = document.createElement("li");
      item.innerHTML = `<strong>${cve.cve_id}</strong>: ${cve.description} <br><em>${cve.vendor} - ${cve.product}</em>`;
      list.appendChild(item);
    });
  }

  function renderChart(data = allCVEs) {
    const ctx = document.getElementById("cveChart").getContext("2d");
    const vendorCount = {};

    data.forEach(cve => {
      const v = cve.vendor || "Unknown";
      vendorCount[v] = (vendorCount[v] || 0) + 1;
    });

    const chartData = {
      labels: Object.keys(vendorCount),
      datasets: [{
        label: "# of CVEs",
        data: Object.values(vendorCount),
        backgroundColor: "rgba(128, 0, 0, 0.7)",
      }]
    };

    if (window.cveChart) window.cveChart.destroy(); // avoid duplicates
    window.cveChart = new Chart(ctx, {
      type: "bar",
      data: chartData,
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { title: { display: true, text: "Vendor" } },
          y: { title: { display: true, text: "# of CVEs" }, beginAtZero: true }
        }
      }
    });
  }

  fetchAllCVEs();
</script>
